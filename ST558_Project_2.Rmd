---
title: "ST558 Project 2  Interacting with APIs: Example with the Financial API"
author: "Xi Zeng, Madhur Jiwtani"
date: "2022-10-06"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction  
This document is a vignette to show how to retrieve data from an API. In this project, we will be interacting with the API for financial data. Also, we will build a few functions to interact with some of the endpoints as well as retrieve data to perform a basic exploratory data analysis.  

# Requirements  
To use the functions for interacting with the Financial API, here are some packages needed:  
- `tidyverse`: Collections of packages with useful functions for data manipulation and visualization  
- `jsonlite`: Package needed to interact with API and parse data  
- `httr`: Used for load the data we need from API  

# API Interaction Functions  
Here is the part for the self-defined functions to interact with the Financial API, as well as some helper functions.  

`ConstructURL`  

This function is for interacting with the `Daily Open/Close` endpoint for the Financial API to acquire open,close and after hours prices of a stock symbol on a certain date. For this function, user can specify the stocksTicker; lowercase, uppercase and camelcase.etc are accepted). Also, for date, we accept following formats:  
+`%m/%d/%Y`  
+`%m-%d-%Y`  
+`%Y/%m/%d`  
+`%Y-%m-%d`  
For the `adjusted`, it means whether or not the results are adjusted for splits. Here, the default will be the results are adjusted, but user can self define it as well.  

```{r, eval=TRUE,echo=TRUE}
#Load the library needed for the function
library(tidyverse)
library(httr)
library(jsonlite)

#Example for getting the data we want.
Mydata <- GET("https://api.polygon.io/v1/open-close/AAPL/2020-10-14?adjusted=true&apiKey=pxkABpfvwGyIl55tOWtNxricS6IwKFYH")
parsed <- fromJSON(rawToChar(Mydata$content))

#Construct API
ConstructURL <- function(stocksTicker, date, adjusted = "true"){
  BasicURL <- "https://api.polygon.io/v1/open-close"
  apikey <- "pxkABpfvwGyIl55tOWtNxricS6IwKFYH"
  #Transform the stocksTicker to the upper 
  newstocksTicker <- toupper(stocksTicker)
  #newstocksTicker <- paste(toupper(substr(strsplit(stocksTicker, " ")[[1]],1,1)),collapse = "")
  newadjusted <- tolower(adjusted)
  
  #Transform date to YY-MM-DD format
  date_format <- c("%m/%d/%Y","%m-%d-%Y","%Y/%m/%d","%Y-%m-%d")
  newdate <- format(as.Date(date, tryFormats = date_format), "%Y-%m-%d")
  
  #Get the new URL for requiring data
  newURL <- paste0(BasicURL,"/",newstocksTicker,"/",newdate,"?","adjusted=",newadjusted,"&apiKey=",apikey)
  
  #Require data with functions in httr package
  data <- GET(newURL)
  
  #Parse the data to get the data we want to retrieve 
  parsed <-fromJSON(rawToChar(data$content))
  
  #Tranform the data into data frame
  parsed <- as.data.frame(t(unlist(parsed)))
  return(parsed)
}
#Test if the function works
ConstructURL(stocksTicker = "AApl",date = "2021/10/29")

```

`Market`   

This function is for interacting with the Tickers endpoint. It can be used to query all the different type of market like "Stocks", "Crypto", "FX" and "OTC" which are supported by this Financial API.  

```{r, echo=TRUE, eval=TRUE}
library(tidyverse)
library(httr)
library(jsonlite)

Market<-function(endpoints,type_of_market,limits){
baseUrl="https://api.polygon.io/v3/reference/"
endpoint=endpoints
api_key="Ha9q45MxKhMXoq7bPseOEPNpQ7XBpLoh"
market=type_of_market
limit=limits
targetUrl<-paste(baseUrl, endpoint, "?", "market", "=", market,"&limit=",limit,"&apiKey=",api_key,sep="")

tickerData <- GET(targetUrl)
parsedTickerData <- fromJSON(rawToChar(tickerData$content))
parsedTickerData$results$currency_name<-toupper(parsedTickerData$results$currency_name)
return(parsedTickerData$results)

}
Market("tickers","fx",1000)

```

`Type_of_stock`

This function is for interacting with the Tickers endpoint. It will help the user to get a set of stocks and their information according to the type of stock. The user gets the flexibility to either enter the abbreviation or the full string of the type of stock. User can also specify the maximum number of stocks they want to see.

```{r}
Type_of_Stock<-function(endpoints,type_of_stock,limits,abbreviation){
  if (!abbreviation)
    {
    tickerDetail<-GET("https://api.polygon.io/v3/reference/tickers/types?asset_class=stocks&apiKey=Ha9q45MxKhMXoq7bPseOEPNpQ7XBpLoh")
  parsedTickerDetail <- fromJSON(rawToChar(tickerDetail$content))
  result <- as_tibble(parsedTickerDetail$results)
  result <- result %>% filter(description == type_of_stock)
  type=as.character(result[,c("code")])
  }
  else{
    type=type_of_stock
  }
baseUrl="https://api.polygon.io/v3/reference/"
endpoint=endpoints
api_key="Ha9q45MxKhMXoq7bPseOEPNpQ7XBpLoh"
limit=limits
targetUrl<-paste(baseUrl, endpoint, "?", "type", "=", type,"&limit=",limit,"&apiKey=",api_key,sep="")

tickerData <- GET(targetUrl)
parsedTickerData <- fromJSON(rawToChar(tickerData$content))
parsedTickerData$results$currency_name<-toupper(parsedTickerData$results$currency_name)
return(parsedTickerData$results)
}
Type_of_Stock("tickers","Common Stock",1000,FALSE)  
```

`func3`  

This function is used for interacting with the Dividend endpoint.
Function 3 : Interacting with Dividend Endpoint


```{r}
func3<- GET("https://api.polygon.io/v3/reference/dividends?&limit=1000&apiKey=Ha9q45MxKhMXoq7bPseOEPNpQ7XBpLoh")
dividend<- fromJSON(rawToChar(func3$content))
dividend$results
```


# Exploratory Data Analysis  

## Data query

Below is the part of function call for exploratory data analysis. In this part, I pulled the open,close and after hours prices of several stocks(AAPL,AXP and AAL) between certain date(10/11/2021 - 10/22/2021).  


```{r}
#Pull data from API for several stockStickers and a specific period of time.


#Set the stockSticker for query
stockSticker_call <- c("aapl","axP","AAL")

#Set the time frame for query
date_call <- c("10/11/2021","10/12/2021","10/13/2021","10/14/2021","10/15/2021",
          "10-18-2021","10-19-2021","10-20-2021","10-21-2021","10-22-2021")

#Define count number for setting system sleep time because of the limits of API query.
count = 0

#Call the ConstructURL once to set a data frame
data_pull <- ConstructURL("aapl","10/11/2021")

#Conduct a nested loop for querying data I need
for (i in stockSticker_call){
    for (j in date_call){
      data_call <- ConstructURL(i,j)
      data_pull <- rbind(data_pull,data_call)
      count = count + 1
      if (count == 4) {
        count = 0
        Sys.sleep(61)
      }
  }
}

#Delete the first row and keep what we need
data_pull = data_pull[-1, ]
```


## Data Manipulation  

Below is part for create new variables. Here, I create a new variable change that records the change price of the stockSticker from open time to close time. Also a new categorical variable 'summary'is created, it indicates if the stock price rises or declines.If the `change` variable is greater than 0, indicates the stockprice rises at that specific date, vice versa.If `change` = 0, indicates the stock price remain the same for that day.

```{r echo=TRUE, eval=TRUE}
data_pull <- tibble(data_pull)

#Create a new variable change as well as a categorical variable summary 
newdata <- data_pull %>% mutate(change = as.numeric(close) - as.numeric(open),
                                summary = ifelse(change > 0, "rise",
                                                 ifelse(change < 0, "decline", "same")))
newdata
```

This part is for creating numerical summaries for some quantitative variables at each setting of the categorical variables  .

```{r echo=TRUE,eval=TRUE}
#In this part, the mean volume for each stockSticker is summarised
 a <- data_pull %>%
        group_by(symbol)%>%
         summarise(mean_volume = mean(as.numeric(volume)))
```

In this part, the above data with new variables created is utilized to create contigency table. The table displays the frequency of the stock price status for each stock sticker.

```{r echo=TRUE,eval=TRUE}
table(newdata$summary,newdata$symbol)
```

According to the table generated, in the specific time period(Includes the week of 10/11/2021 and the week of 10/18/2021), the stock price for AAL declines for 7 days and rises for 3 days. The stock price for AAPL declines for 3 days and rises for 7 days. The stock price for AXP declines for 4 days and rises for 6 days.  

## Graphs

In this part, we are going to generate multiple graphs for exploratory analysis of the data. And each graph will contains the interpretation for it below the graph.

### Barplot

```{r, echo=TRUE, eval=TRUE}
newdata
g <- ggplot(data = newdata, aes(x = summary))
g + geom_bar(aes(fill = symbol), position = "dodge")+
  labs(x = "Summary of the stock Price", fill = "Stock Sticker")

```

Above is the barplot for summarising the `summary` variable in the dataset, it shows the frequency count for rise and decline of each stock sticker.It seems that AAPL has a better stock performance at this time period, the stock price of AAL seems to be declining most of the time.  

### Histogram
```{r, echo=TRUE, eval=TRUE}
newdata
ggplot(newdata,aes(x = as.numeric(afterHours)))+
  geom_histogram()
```



This is the code to render the README file.
```{r, eval = FALSE}
library(rmarkdown)
rmarkdown::render(input = "ST558_update_check.Rmd",
                  output_file = "README.md")
```
