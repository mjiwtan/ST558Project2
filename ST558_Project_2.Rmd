---
title: "ST558 Project 2  Interacting with APIs: Example with the Financial API"
author: "Xi Zeng, Madhur Jiwtani"
date: "2022-10-06"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction  
This document is a vignette to show how to retrieve data from an API. In this project, we will be interacting with the API for financial data. Also, we will build a few functions to interact with some of the endpoints as well as retrieve data to perform a basic exploratory data analysis.  

# Requirements  
To use the functions for interacting with the Financial API, here are some packages needed:  
- `tidyverse`: Collections of packages with useful functions for data manipulation and visualization  
- `jsonlite`: Package needed to interact with API and parse data  
- `httr`: Used for load the data we need from API  

# API Interaction Functions  
Here is the part for the self-defined functions to interact with the Financial API, as well as some helper functions.  

`Function1`  

This function is for interacting with the `Daily Open/Close` endpoint for the Financial API to acquire open,close and afterhours prices of a stock symbol on a certain date.  

```{r}
library(tidyverse)
library(httr)
library(jsonlite)
#Example for getting the data we want.
Mydata <- GET("https://api.polygon.io/v1/open-close/AAPL/2020-10-14?adjusted=true&apiKey=pxkABpfvwGyIl55tOWtNxricS6IwKFYH")
parsed <- fromJSON(rawToChar(Mydata$content))
#Construct API

ConstructURL <- function(stocksTicker, date, adjusted){
  BasicURL <- "https://api.polygon.io/v1/open-close"
  #IF there is blank in the stocksTicker, do this to transform
  newstocksTicker <- paste(toupper(substr(strsplit(stocksTicker, " ")[[1]],1,1)),collapse = "")
  #If no blank exists, no need to transform
  ifelse()
  apikey <- "pxkABpfvwGyIl55tOWtNxricS6IwKFYH"
  newdate <- format(as.Date(nzd$date, format = "%d/%m/%Y"), "%Y-%m-%d")
  URL <- paste(BasicURL,newstocksTicker,)
} 

```

Function 2 : Interacting with Ticker Endpoint
```{r}
library(tidyverse)
library(httr)
library(jsonlite)
library(plyr)
query<-function(endpoints,type_of_market,limits,stocktype,abbreviation){
  baseUrl="https://api.polygon.io/v3/reference/"
endpoint=endpoints
api_key="Ha9q45MxKhMXoq7bPseOEPNpQ7XBpLoh"
market=type_of_market
limit=limits
targetUrl<-paste(baseUrl, endpoint, "?", "market", "=", market,"&limit=",limit,"&apiKey=",api_key,sep="")

tickerData <- GET(targetUrl)
parsedTickerData <- fromJSON(rawToChar(tickerData$content))
parsedTickerData$results$currency_name<-toupper(parsedTickerData$results$currency_name)

  
if (!abbreviation)
    {
    tickerDetail<-GET("https://api.polygon.io/v3/reference/tickers/types?asset_class=stocks&apiKey=Ha9q45MxKhMXoq7bPseOEPNpQ7XBpLoh")
  parsedTickerDetail <- fromJSON(rawToChar(tickerDetail$content))
  parsedTickerData$results$type <- mapvalues(parsedTickerData$results$type, from=parsedTickerDetail$results$code,to=parsedTickerDetail$results$description)
  }

answer<- parsedTickerData$results %>%filter(parsedTickerData$results$type==stocktype)
return(answer)
 
}
query("tickers","stocks",1000,"Common Stock",FALSE)

```

Function 3 : Interacting with Dividend Endpoint
```{r}
func3<- GET("https://api.polygon.io/v3/reference/dividends?&limit=1000&apiKey=Ha9q45MxKhMXoq7bPseOEPNpQ7XBpLoh")
dividend<- fromJSON(rawToChar(func3$content))
dividend$results
```
This is the code to render the README file.
```{r, eval = FALSE}
library(rmarkdown)
rmarkdown::render(input = "ST558_update_check.Rmd",
                  output_file = "README.md")
```
